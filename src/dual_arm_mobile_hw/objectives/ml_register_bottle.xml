<?xml version="1.0" encoding="UTF-8" ?>
<root BTCPP_format="4" main_tree_to_execute="ML Register Bottle">
  <BehaviorTree ID="ML Register Bottle" _description="" _favorite="true">
    <Control ID="Sequence">
      <Decorator ID="Repeat" num_cycles="1">
        <Control ID="Sequence" name="TopLevelSequence">
          <Action
            ID="SwitchController"
            activate_asap="true"
            automatic_deactivation="true"
            controller_list_action_name="/controller_manager/list_controllers"
            controller_switch_action_name="/controller_manager/switch_controller"
            strictness="1"
            timeout="-1.000000"
            deactivate_controllers="joint_trajectory_controller"
          />
          <SubTree ID="Open Left Gripper" _collapsed="true" />
          <SubTree
            ID="Move to Waypoint"
            _collapsed="true"
            acceleration_scale_factor="1.0"
            controller_action_server="/left_manipulator_joint_trajectory_controller/follow_joint_trajectory"
            controller_names="left_manipulator_joint_trajectory_controller"
            joint_group_name="left_manipulator"
            keep_orientation="false"
            keep_orientation_tolerance="0.05"
            link_padding="0.01"
            seed="0"
            velocity_scale_factor="1.0"
            waypoint_name="Look At Table - Left ARM"
          />
          <Action ID="ClearSnapshot" />
          <SubTree ID="Take Wrist Camera Snapshot" _collapsed="true" />
          <Action
            ID="SwitchUIPrimaryView"
            primary_view_name="/masks_visualization"
          />
          <SubTree
            ID="Segment Image from No Negative Text Prompt Subtree"
            clip_model_path="models/clip.onnx"
            clipseg_model_path="models/clipseg.onnx"
            erosion_size="2"
            masks_visualization_topic="/masks_visualization"
            model_package="moveit_pro_clipseg"
            threshold="0.15"
            prompts="a bottle"
            image_topic_name="/camera/left_wrist_mounted_camera/color/image_raw"
            masks2d="{masks2d}"
            masks2d_refined="{masks2d}"
          />
          <Action
            ID="GetElementOfVector"
            element="{bottle_element}"
            index="0"
            vector_in="{masks2d}"
          />
          <Action
            ID="GetCenterFromMask2D"
            center="{center}"
            mask="{bottle_element}"
          />
          <Action
            ID="GetImage"
            message_out="{sam2image}"
            publisher_timeout_sec="5.000000"
            timeout_sec="5.000000"
            topic_name="/camera/left_wrist_mounted_camera/color/image_raw"
          />
          <Action
            ID="GetMasks2DFromPointQuery"
            masks2d="{sam2masks2d}"
            decoder_model_path="models/decoder.onnx"
            encoder_model_path="models/sam2_hiera_large_encoder.onnx"
            model_package="dual_arm_mobile_sim"
            pixel_coords="{center}"
            image="{sam2image}"
          />
          <Action
            ID="PublishMask2D"
            image="{sam2image}"
            masks="{sam2masks2d}"
            masks_visualization_topic="/masks_visualization"
            opacity="0.500000"
          />
          <Action
            ID="GetCameraInfo"
            message_out="{left_camera_info}"
            publisher_timeout_sec="5.000000"
            timeout_sec="5.000000"
            topic_name="/camera/left_wrist_mounted_camera/color/camera_info"
          />
          <Action
            ID="GetPointCloud"
            message_out="{left_point_cloud}"
            publisher_timeout_sec="5.000000"
            timeout_sec="5.000000"
            topic_name="/camera/left_wrist_mounted_camera/depth/color/points"
          />
          <Action
            ID="GetMasks3DFromMasks2D"
            camera_info="{left_camera_info}"
            masks2d="{sam2masks2d}"
            masks3d="{masks3d}"
            point_cloud="{left_point_cloud}"
          />
          <Action
            ID="GetElementOfVector"
            element="{mask3d}"
            index="0"
            vector_in="{masks3d}"
          />
          <Action
            ID="GetPointCloudFromMask3D"
            mask3d="{mask3d}"
            point_cloud="{left_point_cloud}"
            point_cloud_fragment="{point_cloud_fragment}"
          />
          <Action
            ID="TransformPointCloudFrame"
            input_cloud="{point_cloud_fragment}"
            output_cloud="{point_cloud_fragment}"
            target_frame="world"
          />
          <Action ID="ClearSnapshot" />
          <Action
            ID="SendPointCloudToUI"
            pcd_topic="/pcd_pointcloud_captures"
            point_cloud="{point_cloud_fragment}"
          />
          <Action
            ID="LoadPointCloudFromFile"
            frame_id="world"
            num_sampled_points="10000"
            point_cloud="{ref_bottle_point_cloud}"
            scale="0.001"
            package_name="dual_arm_mobile_sim"
            random_seed="0"
            file_path="description/assets/trainer_hatch/collision/cylinder_mockup_full_length.stl"
            color="255;0;0"
          />
          <Action
            ID="CreateStampedPose"
            reference_frame="world"
            stamped_pose="{bottle_init_pose}"
            orientation_xyzw="0;0;0;1"
            position_xyz="1.16;0.43;1.12"
          />
          <Action
            ID="TransformPointCloud"
            input_cloud="{ref_bottle_point_cloud}"
            transform_pose="{bottle_init_pose}"
            output_cloud="{ref_bottle_point_cloud}"
          />
          <Action ID="ClearSnapshot" _skipIf="true" />
          <Action
            ID="SendPointCloudToUI"
            pcd_topic="/pcd_pointcloud_captures"
            point_cloud="{ref_bottle_point_cloud}"
          />
          <Action
            ID="RegisterPointClouds"
            max_correspondence_distance="5.000000"
            max_iterations="30"
            target_point_cloud="{point_cloud_fragment}"
            target_pose_in_base_frame="{bottle_icp_transform}"
            base_point_cloud="{ref_bottle_point_cloud}"
          />
          <Action
            ID="TransformPointCloud"
            input_cloud="{ref_bottle_point_cloud}"
            output_cloud="{output_cloud}"
            transform_pose="{bottle_icp_transform}"
          />
          <Action
            ID="VisualizePose"
            marker_lifetime="0.000000"
            marker_name="pose"
            marker_size="0.100000"
            pose="{bottle_icp_transform}"
          />
          <Action
            ID="SendPointCloudToUI"
            pcd_topic="/pcd_pointcloud_captures"
            point_cloud="{output_cloud}"
          />
          <Control ID="Sequence" name="TopLevelSequence">
            <Action
              ID="TransformPoseWithPose"
              input_pose="{bottle_init_pose}"
              output_pose="{bottle_in_world_pose}"
              transform_pose="{bottle_icp_transform}"
            />
            <Action
              ID="CreateStampedPose"
              reference_frame="world"
              stamped_pose="{table_pose}"
              orientation_xyzw="0.5;0.5;0.5;0.5"
              name="Hard coding the table pose for now but should be taken from qr code on the table"
              position_xyz="0;0;0"
            />
            <SubTree
              ID="GetQuaternionVectorFromPoseStamped"
              pose_stamped_in="{table_pose}"
              quaternion_vector="{table_quaternion_vector}"
            />
            <SubTree
              ID="GetPositionVectorFromPoseStamped"
              pose_stamped_in="{bottle_in_world_pose}"
              position_vector="{position_vector}"
            />
            <Action
              ID="CreateStampedPose"
              reference_frame="world"
              orientation_xyzw="{table_quaternion_vector}"
              position_xyz="{position_vector}"
              stamped_pose="{bottle_bottom_aligned_pose}"
            />
            <Action
              ID="TransformPose"
              input_pose="{bottle_bottom_aligned_pose}"
              output_pose="{bottle_bottom_aligned_pose}"
              translation_xyz="0;0;0"
              quaternion_xyzw="0;-0.7071;0;0.7071"
            />
            <Action
              ID="TransformPose"
              input_pose="{bottle_bottom_aligned_pose}"
              output_pose="{bottle_bottom_aligned_pose}"
              translation_xyz="0;0.2;-0.1"
              quaternion_xyzw="0;0;0;0"
            />
            <Action
              ID="VisualizePose"
              marker_lifetime="0.000000"
              marker_name="bottle_bottom_aligned"
              marker_size="0.100000"
              pose="{bottle_bottom_aligned_pose}"
              marker_text="bottle_bottom_aligned_pose"
            />
          </Control>
          <Action
            ID="BreakpointSubscriber"
            breakpoint_topic="/moveit_pro_breakpoint"
          />
          <SubTree
            ID="Move to Pose"
            controller_names="left_manipulator_joint_trajectory_controller;left_robotiq_gripper_controller"
            ik_frame="left_grasp_link"
            link_padding="0.01"
            planning_group_name="left_manipulator"
            require_user_approval="false"
            velocity_scale_factor="1.0"
            name="move-to-prepick"
            _collapsed="true"
            target_pose="{bottle_bottom_aligned_pose}"
          />
          <Action
            ID="CreateStampedPose"
            stamped_pose="{pick-pose}"
            name="create-prepick-pose"
            reference_frame="world"
            position_xyz="0;0;0.1"
          />
          <Action
            ID="TransformPose"
            input_pose="{bottle_bottom_aligned_pose}"
            output_pose="{pick-pose}"
            translation_xyz="0;0;0.12"
            quaternion_xyzw="0;0;0;0"
          />
          <SubTree
            ID="Move to Pose"
            controller_names="left_manipulator_joint_trajectory_controller;left_robotiq_gripper_controller"
            ik_frame="left_grasp_link"
            link_padding="0.01"
            planning_group_name="left_manipulator"
            require_user_approval="false"
            target_pose="{pick-pose}"
            velocity_scale_factor="1.0"
            name="move-to-prepick"
            _collapsed="true"
          />
          <Action
            ID="VisualizePose"
            marker_lifetime="0.000000"
            marker_name="pick-pose"
            marker_size="0.100000"
            pose="{pick-pose}"
            marker_text="pick-pose"
          />
          <SubTree ID="Close Left Gripper" _collapsed="true" />
          <Action
            ID="CreateStampedPose"
            stamped_pose="{high_pick_pose}"
            name="create-prepick-pose"
            reference_frame="world"
          />
          <Action
            ID="TransformPose"
            input_pose="{pick-pose}"
            output_pose="{high_pick_pose}"
            translation_xyz="0;0.3;0"
            quaternion_xyzw="0;0;0;0"
          />
          <SubTree
            ID="Move to Pose"
            controller_names="left_manipulator_joint_trajectory_controller;left_robotiq_gripper_controller"
            ik_frame="left_grasp_link"
            link_padding="0.01"
            planning_group_name="left_manipulator"
            require_user_approval="false"
            target_pose="{high_pick_pose}"
            velocity_scale_factor="1.0"
            name="move-to-prepick"
            _collapsed="true"
          />
          <Action
            ID="VisualizePose"
            marker_lifetime="0.000000"
            marker_size="0.100000"
            pose="{high_pick_pose}"
            marker_text="high_pick_pose"
            marker_name="high_pick_pose"
          />
          <SubTree ID="Open Left Gripper" _collapsed="true" />
        </Control>
      </Decorator>
    </Control>
  </BehaviorTree>
  <TreeNodesModel>
    <SubTree ID="ML Register Bottle" />
  </TreeNodesModel>
</root>
